generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---
enum Role {
  STUDENT
  HR
  ADMIN
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum AssessmentType {
  PRACTICE  // Generated by AI from Resume
  OFFICIAL  // Assigned by HR
}

enum AssessmentStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

// --- MODELS ---

model User {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  name     String
  email    String @unique
  password String
  role     Role   @default(STUDENT)
  
  // New: Stores AI-parsed resume data (skills, seniority, etc.)
  profileData Json? 

  createdAt DateTime @default(now())

  // Relations
  createdAssessments Assessment[] @relation("CreatedByHR")
  takenAssessments   Assessment[] @relation("TakenByCandidate")
  reports            Report[]
}

model Assessment {
  id          String           @id @default(auto()) @map("_id") @db.ObjectId
  
  // Relations
  candidateId String           @db.ObjectId
  candidate   User             @relation("TakenByCandidate", fields: [candidateId], references: [id])
  
  // Made Optional: AI-generated assessments don't have an HR creator
  hrId        String?          @db.ObjectId
  hr          User?            @relation("CreatedByHR", fields: [hrId], references: [id])

  // Metadata
  title       String           @default("General Assessment")
  status      AssessmentStatus @default(PENDING)
  difficulty  Difficulty       @default(EASY)
  type        AssessmentType   @default(PRACTICE)
  
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Modules
  technicalAssessment TechnicalAssessment?
  behavioralInterview BehavioralInterview?
  report              Report?
}

model TechnicalAssessment {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  assessmentId String   @unique @db.ObjectId
  assessment   Assessment @relation(fields: [assessmentId], references: [id])
  
  status       String   // "PENDING", "COMPLETED"
  
  // Execution Data
  code         String?  // The user's submitted code
  language     String?  // "javascript", "python"
  
  // Results
  score             Float?   // 0-100
  evaluationResults Json?    // Detailed test case results from Python engine

  // Linked Questions
  questionIds String[]         @db.ObjectId
  questions   CodingQuestion[] @relation(fields: [questionIds], references: [id])

  startedAt   DateTime  @default(now())
  completedAt DateTime?
}

model BehavioralInterview {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  assessmentId String     @unique @db.ObjectId
  assessment   Assessment @relation(fields: [assessmentId], references: [id])
  
  status       String
  transcript   Json?      // Stores the conversation logs from Hume
  
  startedAt    DateTime   @default(now())
  completedAt  DateTime?
}

model Report {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  assessmentId String     @unique @db.ObjectId
  assessment   Assessment @relation(fields: [assessmentId], references: [id])
  
  candidateId  String     @db.ObjectId
  candidate    User       @relation(fields: [candidateId], references: [id])
  
  // AI Generated Analysis
  summary             String?
  strengths           Json?   // ["React", "System Design"]
  areasForImprovement Json?   // ["Error Handling", "Testing"]
  
  // Scores
  technicalScore      Float?
  behavioralScores    Json?   // { "communication": 85, "confidence": 90 }
  
  createdAt           DateTime @default(now())
}

model CodingQuestion {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  
  // Enforced Enum for filtering
  difficulty  Difficulty 
  
  // Content
  testCases   Json       // [{ input: "...", output: "..." }]
  starterCode Json?      // { "javascript": "function...", "python": "def..." }
  
  createdAt   DateTime   @default(now())

  // Relations
  technicalAssessmentIds String[]              @db.ObjectId
  technicalAssessments   TechnicalAssessment[] @relation(fields: [technicalAssessmentIds], references: [id])

  @@index([difficulty])
}